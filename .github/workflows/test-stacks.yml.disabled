name: Test Docker Stacks

on:
  pull_request:
    branches: [main]
    paths:
      - "docker-compose-examples/**"
      - ".github/workflows/test-stacks.yml"
  push:
    branches: [main]
    paths:
      - "docker-compose-examples/**"
  workflow_dispatch:

jobs:
  test-basic-stack:
    name: Test Basic Stack
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v4

      - name: Test Basic Stack
        run: |
          cd docker-compose-examples/basic-stack
          docker-compose up -d --build
          timeout 300 bash -c 'until curl -f http://localhost:3000/health; do sleep 5; done'
          timeout 300 bash -c 'until curl -f http://localhost:8001/health; do sleep 5; done'
          docker-compose logs
          docker-compose down

  test-cluster-example:
    name: Test Cluster Example
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v4

      - name: Test Cluster Example
        run: |
          cd docker-compose-examples/cluster-example
          docker-compose up -d --build
          timeout 300 bash -c 'until curl -f http://localhost:3000/health; do sleep 5; done'
          timeout 300 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'
          # Test load balancer
          timeout 300 bash -c 'until curl -f http://localhost:8080/; do sleep 5; done'
          docker-compose logs
          docker-compose down

  test-swarm-stack:
    name: Test Swarm Stack
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v4

      - name: Test Swarm Stack
        run: |
          cd docker-compose-examples/swarm-stack
          # Create external network for testing
          docker network create react-scuba-swarm_swarm-network || true
          docker-compose up -d --build
          timeout 300 bash -c 'until curl -f http://localhost:3000/; do sleep 5; done'
          timeout 300 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'
          docker-compose logs
          docker-compose down
          # Clean up network
          docker network rm react-scuba-swarm_swarm-network || true

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        run: npm test -- --run --coverage

      - name: Run linting
        run: npm run lint

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
