# ==============================================================================
# Web Dev - React Vite Development Server
# ==============================================================================
# Purpose: Hot-reload development environment for React frontend
# Architecture: Development-optimized with volume mounts for fast iteration
# Base: node-compiler (pre-configured build environment)
# Optimization: Full dependencies retained for dev tools, npm workspaces
# Separation of Concerns: Frontend-only, React 19 + Vite 7, HMR support
# ==============================================================================

# ============================================================================
# Stage 1: Compile - Build frontend with all dev tools
# ============================================================================
FROM node:22-slim AS compile

LABEL stage="compile" description="Build stage for web dev server"

# Install build-time dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    ca-certificates \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Configure npm for optimal performance
ENV NPM_CONFIG_CACHE=/build/.npm-cache \
    NPM_CONFIG_LOGLEVEL=warn \
    NODE_OPTIONS="--max-old-space-size=2048" \
    NODE_ENV=development

WORKDIR /build

# Create npm cache directory for layer caching
RUN mkdir -p /build/.npm-cache && chmod -R 777 /build/.npm-cache

# Copy workspace structure
COPY server/package.json server/package-lock.json ./
COPY server/packages ./packages
COPY server/apps/web ./apps/web

# Install all dependencies including dev tools
RUN npm ci --prefer-offline --no-audit --no-fund --legacy-peer-deps

# Pre-build for faster startup (optional, can be skipped for pure dev)
RUN npm run build --filter=@react-scuba/web 2>/dev/null || true

# ============================================================================
# Stage 2: Runtime - Full dev environment
# ============================================================================
FROM node:22-slim

LABEL \
    org.opencontainers.image.title="React Scuba Web Dev" \
    org.opencontainers.image.description="Development environment for React frontend with Vite" \
    org.opencontainers.image.vendor="React Scuba" \
    maintainer="Dean Luus" \
    purpose="web-dev" \
    version="0.1.0" \
    node.version="22-slim" \
    architecture="x86_64"

# Install development dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    dumb-init \
    curl \
    git \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Create development user (uid 1002 avoids conflicts)
RUN useradd -m -u 1002 -s /bin/bash dev-user

WORKDIR /app

# Development environment configuration
ENV NODE_ENV=development \
    NODE_OPTIONS="--max-old-space-size=1024" \
    NPM_CONFIG_LOGLEVEL=warn \
    PORT=5173 \
    HOST=0.0.0.0 \
    VITE_HMR_HOST=localhost \
    VITE_HMR_PORT=5173

# Copy full workspace with all dependencies and sources
COPY --from=compile --chown=dev-user:dev-user /build ./

# Create cache directory for faster rebuilds
RUN mkdir -p /cache && chown -R dev-user:dev-user /cache

# Expose development server ports
EXPOSE 5173 5174 8080 3001

# Health check (dev server running)
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:5173 || exit 1

# Switch to dev user
USER dev-user

# Use dumb-init to handle signals
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Start Vite dev server with hot module replacement
CMD ["npm", "run", "dev", "--filter=@react-scuba/web"]
